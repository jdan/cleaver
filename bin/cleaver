#!/usr/bin/env node

var path = require('path');
var fs = require('fs');
var program = require('commander');
var Cleaver;

/**
 * Helper function to use the cleaver API to create and save a new
 * presentation
 */
function createAndSave(files, options) {
  files.forEach(function (file) {
    fs.readFile(file, 'utf-8', function (err, contents) {
      var presentation = new Cleaver(contents, options, path.resolve(path.dirname(file)));

      presentation.run()
        .then(function (product) {
          var outputFile = presentation.options.output || path.basename(file, '.md') + '-cleaver.html';
          fs.writeFile(outputFile, product);
        })
        .fail(function (err) {
          process.stderr.write('!! ' + err.message + '\n');
          if (program.debug) {
            process.stderr.write(err.stack);
          }
          process.exit(1);
        });
    });
  });
}

program
  .version(require('../package.json').version)
  .usage('[command] [file]');

program
  .command('watch')
  .description('Watch for changes on markdown file')
  .action(function () {
    var file = program.args[0];
    createAndSave([file], parsedOpts);

    console.log('Watching for changes on ' + file + '. Ctrl-C to abort.');
    fs.watchFile(file, { persistent: true, interval: 100 }, function () {
      console.log('Rebuilding: ' + new Date());
      createAndSave([file], parsedOpts);
    });
  });

program
  .option('--title <title>', 'The title of the rendered document ' +
          '(default: Untitled')
  // TODO: author options
  .option('--theme <theme>', 'An theme to load')
  .option('--style <css>', 'A particular stylesheet to load')
  .option('--output <filename>', 'The filename of the rendered document ' +
          '(default: [INPUT]-cleaver.html)')
  .option('--controls', 'Whether or not to include simple navigation ' +
          'controls in your presentation (default: true)')
  .option('--progress', 'Option to display a small progress bar at the top ' +
          'of your presentation (default: true)')
  .option('--encoding <encoding>', 'Content encoding used for the rendered ' +
          'document (default: utf-8)')
  .option('--template <path>', 'URL or path to a mustache template used for ' +
          'individual slides')
  .option('--layout <path>', 'URL or path to a mustache template used to ' +
          'render the entire presentation')
  .option('--debug', 'Enable debug output');

program.parse(process.argv);

// TODO: a lot of code duplication here
var parsedOpts = {
  title: program.title,
  theme: program.theme,
  style: program.style,
  output: program.output,
  controls: program.controls,
  progress: program.progress,
  encoding: program.encoding,
  template: program.template,
  layout: program.layout,
  debug: program.debug
};

if (!program.args.length) {
  // TODO: custom help screen
  program.help();
} else {
  /**
   * Enable debugging
   *
   * For finer-tuned debugging you can ignore the --debug flag and
   * instead use the DEBUG environment variable that the `debug` module
   * reads automatically.
   *
   * $ DEBUG=[cleaver,helper] cleaver path/to/presentation.md
   */
  if (program.debug) {
    process.env.DEBUG = '*';
  }

  // Load cleaver with the new ENV for debugging
  // TODO: This seems a little janky, maybe handle this in lib/
  Cleaver = require('../');
  createAndSave(program.args, parsedOpts);
}
